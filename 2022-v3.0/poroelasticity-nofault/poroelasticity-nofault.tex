% -*- TeX -*-
\documentclass[aspectratio=169]{beamer}

\title{PyLith v3.0 Tutorial}
\subtitle{Quasi-static Poroelasticity with No Fault}
\author{Robert Walker \\
  Matthew Knepley\\
  Brad Aagaard}
\institute{\includegraphics[scale=1.5]{../../logos/cig_logo_dots}%
  \hspace{4em}%
\raisebox{1em}{\includegraphics[scale=1.0]{../../logos/cig_short_pylith}}}
\date{June 21, 2022}


% ---------------------------------------------------- CUSTOMIZATION
\usetheme{CIG}
\input{../style}

% ========================================================= DOCUMENT
\begin{document}

% ------------------------------------------------------------ SLIDE
\maketitle

\logo{\includegraphics[height=4.5ex]{../../logos/cig_short_pylith}}

% ========================================================== SECTION
\section{{\ttfamily examples/magma-2d}}

% ========================================================== SUBSECTION
\subsection{Overview}

% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{2D Magma Reservoir Using Poroelasticity: {\ttfamily examples/magma-2d}}
  \summary{}

  \includefigure[height=6.1cm]{figs/geometry}

  \vfill
  Model flow and deformation for a magma reservoir with poroelastic properties that differ from the surrounding domain.
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Steps in example}
  \summary{}

  \begin{description}
    \item[Step 1] \highlight{Magma influx with displacement and pressure boundary conditions}
  \end{description}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Concepts covered}
  \summary{}

  \begin{itemize}
  \item Generation of mesh using Cubit
  \item Variable mesh size with distance from the magma reservoir
  \item Quasistatic simulations for poroelasticity
  \item Elastic bulk rheology
  \item Dirichlet fluid pressure boundary condition
  \item Initial condition for fluid pressure
  \end{itemize}

\end{frame}


% ========================================================== SUBSECTION
\subsection{Finite-Element Mesh}

% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Cubit: Geometry}
  \summary{}

  \includefigure[height=7.0cm]{figs/geometry}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Cubit: Creating the finite-element mesh}
  \summary{We create the mesh using geometric primitives}

  \includefigure[height=6.5cm]{figs/cubit-quad}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Files used in simulations}
  \summary{Files are in directory {\ttfamily examples/magma-2d}}

  \begin{description}
  \item[README.md] Brief description of the various examples
  \item[*.cfg] PyLith parameter files
  \item[*.jou] Cubit Journal scripts used to generate the mesh
  \item[*.exo] Finite-element mesh files generated by Cubit
  \item[*.spatialdb] Spatial database files
  \item[viz] Directory containing ParaView Python scripts
  \item[output] Directory containing simulation output; created automatically when running the simulations
  \end{description}

\end{frame}
  

% ========================================================== SECTION
\subsection{step01-inflation}

% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 1: Overview}
  \summary{Inflation of the magma reservoir}

  \includefigure[height=6.5cm]{figs/step01-diagram}
      
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 1: Physics}
  \summary{}

  \begin{minipage}{0.35\textwidth}
    {\scriptsize
      \begin{gather*}
        % Solution
        \vec{s} = \left(\vec{u} \quad p \quad \epsilon_v\right)^T \\
        % Elasticity
        \nabla \cdot \boldsymbol{\sigma}(\vec{u},p) = \vec{0} \\
        % Pressure
        \frac{\partial \zeta(\vec{u},p)}{\partial t} + \nabla \cdot \vec{q}(p) = 0 \\
        % Vol. Strain
        \nabla \cdot \vec{u} - \epsilon_{v} = 0 \\
        % Dirichlet displacement
        u_x = 0 \text{ on boundary\_xneg} \\
        u_x = 0 \text{ on boundary\_xpos} \\
        u_y = 0 \text{ on boundary\_yneg} \\
        % Dirichlet pressure
        p = 0 \text{ on boundary\_ypos} \\
        p = 10 \text{\,MPa on boundary\_flow} \\
        p(t=0) = 5 \text{\,MPa  in domain}
    \end{gather*}}
  \end{minipage}
  \hfill
  \begin{minipage}{0.55\textwidth}
    \includefigure[height=6.5cm]{figs/step01-diagram}
  \end{minipage}
      
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}[t,fragile]
  \frametitle{Step 1: Physics to simulation parameters}
  \summary{}

  \begin{minipage}[t]{0.3\textwidth}
    {\scriptsize
    \begin{gather*}
        % Solution
        \vec{s} = \left(\vec{u} \quad p \quad \epsilon_v\right)^T \tikzmark{solution1}\\
        % Elasticity
        \nabla \cdot \boldsymbol{\sigma}(\vec{u},p) = \vec{0} \tikzmark{material1}\\
        % Pressure
        \frac{\partial \zeta(\vec{u},p)}{\partial t} + \nabla \cdot \vec{q}(p) = 0 \\
        % Vol. Strain
        \nabla \cdot \vec{u} - \epsilon_{v} = 0 \\
        % Dirichlet displacement
        u_x = 0 \text{ on boundary\_xneg} \tikzmark{bc1}\\
        u_x = 0 \text{ on boundary\_xpos} \\
        u_y = 0 \text{ on boundary\_yneg} \\
        % Dirichlet pressure
        p = 0 \text{ on boundary\_ypos} \\
        p = 10 \text{\,MPa on boundary\_flow} \\
        p(t=0) = 5 \text{\,MPa in domain} \tikzmark{ic1}
    \end{gather*}}
  \end{minipage}
  \hfill
  \begin{minipage}[t]{0.67\textwidth}
    % Solution
    \begin{onlyenv}<2>
      \tikzmark{solution1-cfg}
      \begin{cfgcode}
        [pylithapp.problem]
        solution = pylith.problems.SolnDispPresTracStrain

        [pylithapp.problem.solution.subfields]
        displacement.basis_order = 2
        pressure.basis_order = 1
        trace_strain.basis_order = 1
        
        [pylithapp.problem]
        normalizer = spatialdata.units.NondimElasticQuasistatic
        normalizer.length_scale = 100.0*m
        normalizer.relaxation_time = 0.2*year
        normalizer.shear_modulus = 10.0*GPa
      \end{cfgcode}
    \end{onlyenv}
    %
    % Governing equations
    \begin{onlyenv}<3>
      \tikzmark{material1-cfg}
      \begin{cfgcode}
        [pylithapp.problem]
        materials = [crust, intrusion]
        materials.crust = pylith.materials.Poroelasticity
        materials.intrusion = pylith.materials.Poroelasticity

        [pylithapp.problem.materials]
        crust.bulk_rheology = pylith.materials.IsotropicLinearPoroelasticity
        intrusion.bulk_rheology = pylith.materials.IsotropicLinearPoroelasticity

        [pylithapp.problem.materials.crust]
        description = crust
        label_value = 1

        db_auxiliary_field = spatialdata.spatialdb.UniformDB
        db_auxiliary_field.description = Poroelastic properties for the crust
        db_auxiliary_field.values = [solid_density, fluid_density, fluid_viscosity, porosity, shear_modulus, drained_bulk_modulus, biot_coefficient, fluid_bulk_modulus, solid_bulk_modulus, isotropic_permeability]
        db_auxiliary_field.data   = [ 2500*kg/m**3,  1000*kg/m**3,      0.001*Pa*s,     0.01,        6e9*Pa,              10e9*Pa,              1.0,             2e9*Pa,            20e9*Pa,             1e-15*m**2]
        ...
      \end{cfgcode}
    \end{onlyenv}
    %
    % Boundary conditions
    \begin{onlyenv}<4>
      \tikzmark{bc1-cfg}
      \begin{cfgcode}
        [pylithapp.problem]
        bc = [bc_xneg, bc_xpos, bc_yneg, bc_ypos, bc_flow]

        bc.bc_xneg = pylith.bc.DirichletTimeDependent
        bc.bc_xpos = pylith.bc.DirichletTimeDependent
        bc.bc_yneg = pylith.bc.DirichletTimeDependent
        bc.bc_ypos = pylith.bc.DirichletTimeDependent
        bc.bc_flow = pylith.bc.DirichletTimeDependent

        ...
        [pylithapp.problem.bc.bc_flow]
        constrained_dof = [0]
        label = boundary_flow
        field = pressure
        db_auxiliary_field = spatialdata.spatialdb.UniformDB
        db_auxiliary_field.description = Flow into external boundary of conduit
        db_auxiliary_field.values = [initial_amplitude]
        db_auxiliary_field.data = [10.0*MPa]
      \end{cfgcode}
    \end{onlyenv}
    \begin{onlyenv}<5>
      \tikzmark{ic1-cfg}
      \begin{cfgcode}
        [pylithapp.problem]
        ic = [domain]
        ic.domain = pylith.problems.InitialConditionDomain

        [pylithapp.problem.ic.domain]
        db = spatialdata.spatialdb.UniformDB
        db.description = Initial conditions for domain
        db.values = [displacement_x, displacement_y, pressure, trace_strain]
        db.data = [0.0*m, 0.0*m, 5.0*MPa, 0.0]
      \end{cfgcode}
    \end{onlyenv}
  \end{minipage}

    
  \begin{tikzpicture}[overlay,remember picture]
    \draw[physics-arrow,visible on=<2>] ($(pic cs:solution1-cfg)-(0,2em)$) to (pic cs:solution1);
    \draw[physics-arrow,visible on=<3>] ($(pic cs:material1-cfg)-(0,2em)$) to (pic cs:material1);
    \draw[physics-arrow,visible on=<4>] ($(pic cs:bc1-cfg)-(0,2em)$) to (pic cs:bc1);
    \draw[physics-arrow,visible on=<5>] ($(pic cs:ic1-cfg)-(0,2em)$) to (pic cs:ic1);
  \end{tikzpicture}

  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 1: Input files}
  \summary{}

  \begin{description}
  \item[mesh\_quad.exo] Finite-element mesh generated using Cubit
  \item[pylithapp.cfg] PyLith parameter file common to all steps
  \item[step01\_inflation.cfg] PyLith parameter file
  \end{description}
    
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}[fragile]
  \frametitle{Step 1: Run the simulation}
  \summary{}

\begin{bashcode}
pylith step01_inflation.cfg

# Output
 >> /Users/baagaard/software/unix/py39-venv/pylith-debug/lib/python3.9/site-packages/pylith/meshio/MeshIOObj.py:44:read
 -- meshiocubit(info)
 -- Reading finite-element mesh
 >> /Users/baagaard/src/cig/pylith/libsrc/pylith/meshio/MeshIOCubit.cc:157:void pylith::meshio::MeshIOCubit::_readVertices(pylith::meshio::ExodusII &, pylith::scalar_array *, int *, int *) const
 -- meshiocubit(info)
 -- Component 'reader': Reading 747 vertices.
 >> /Users/baagaard/src/cig/pylith/libsrc/pylith/meshio/MeshIOCubit.cc:217:void pylith::meshio::MeshIOCubit::_readCells(pylith::meshio::ExodusII &, pylith::int_array *, pylith::int_array *, int *, int *) const
 -- meshiocubit(info)
 -- Component 'reader': Reading 705 cells in 2 blocks.

# -- many lines omitted --

50 TS dt 1. time 49.
    0 SNES Function norm 3.049429649018e-03
    Linear solve converged due to CONVERGED_ATOL iterations 1
    1 SNES Function norm 5.567219918314e-16
  Nonlinear solve converged due to CONVERGED_FNORM_ABS iterations 1
51 TS dt 1. time 50.
 >> /Users/baagaard/software/unix/py39-venv/pylith-debug/lib/python3.9/site-packages/pylith/problems/Problem.py:201:finalize
 -- timedependent(info)
 -- Finalizing problem.
\end{bashcode}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 1: Visualize results}
  \summary{Run the {\tt viz/plot\_dispwarp.py} Python script from within ParaView}

  \includefigure[height=7.0cm]{figs/step01-solution}
    
\end{frame}


% ======================================================================
\end{document}


% End of file
