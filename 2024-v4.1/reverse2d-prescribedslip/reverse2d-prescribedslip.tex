% -*- TeX -*-
\documentclass[aspectratio=169]{beamer}

\title{PyLith v4.1 Tutorial}
\subtitle{Quasi-static Elasticity with Prescribed Fault Slip}
\author{Brad Aagaard\\
  Charles Williams \\
  Matthew Knepley}
\institute{\includegraphics[scale=1.5]{../../logos/cig_logo_dots}%
  \hspace{4em}%
\raisebox{1em}{\includegraphics[scale=1.0]{../../logos/cig_short_pylith}}}
\date{June 10, 2024}


% ---------------------------------------------------- CUSTOMIZATION
\usetheme{CIG}
\input{../style}

% ========================================================= DOCUMENT
\begin{document}

% ------------------------------------------------------------ SLIDE
\maketitle

\logo{\includegraphics[height=4.5ex]{../../logos/cig_short_pylith}}

% ========================================================== SECTION
\section{{\ttfamily examples/reverse-2d}}

% ========================================================== SUBSECTION
\subsection{Overview}

% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Vertical Cross-Section of Reverse Fault (2D): {\ttfamily examples/reverse-2d}}
  \summary{}

  \includefigure[height=6.1cm]{figs/geometry}

  \vfill
  Solve the static and quasistatic boundary elasticity equation for a vertical cross-section of a reverse fault with a splay.
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Steps in example}
  \summary{Steps 1-4 are covered in the gravitational body forces tutorial}

  \begin{description}
    \item[Step 1] Gravitational body forces and linear isotropic elasticity
    \item[Step 2] Gravitational body forces and linear isotropic elasticity with a reference stress state
    \item[Step 3] Gravitational body forces and linear isotropic incompressible elasticity
    \item[Step 4] Surface tractions and linear isotropic linear elasticity
    \item[Step 5] \highlight{Earthquake rupture on one fault and linear isotropic linear elasticity}
    \item[Step 6] \highlight{Earthquake rupture on two faults and linear isotropic linear elasticity}
    \item[Step 7] \highlight{Same as Step 6 but time-dependent with linear isotropic Maxwell viscoelastic rheology}
    \item[Step 8] Same as Step 7 but with linear isotropic power-law viscoelastic rheology
  \end{description}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Concepts covered}
  \summary{}

  \begin{itemize}
  \item Static and quasi-static simulations for elasticity
  \item Prescribed slip earthquake rupture in 2D
  \item Prescribed slip on multiple faults
  \item Elastic and viscoelastic bulk rheologies
  \end{itemize}
  
\end{frame}

% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Gmsh: Finite-Element Mesh}
  \summary{Refer to gravity and surface loading tutorial for mesh generation.}

  \includefigure[height=6.5cm]{figs/gmsh-tri}
  
\end{frame}


% ========================================================== SECTION
\subsection{Files used for simulations}

% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Files used in simulations}
  \summary{Files are in directory {\tt examples/reverse-2d}}

  \begin{description}
  \item[README.md] Brief description of the various examples
  \item[*.cfg] PyLith parameter files
  \item[generate\_gmsh.py] Python script to generate mesh using Gmsh
  \item[*.msh] Finite-element mesh files generated by Gmsh
  \item[*.spatialdb] Spatial database files
  \item[output] Directory containing simulation output; created automatically when running the simulations
  \end{description}

\end{frame}


% ========================================================== SECTION
\subsection{step05-onefault}

% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 5: Overview}
  \summary{Uniform coseismic slip with Dirichlet (displacement) boundary conditions}

  \includefigure[height=6.5cm]{figs/step05-diagram}
      
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 5: Physics}
  \summary{}

  \begin{minipage}{0.3\textwidth}
    {\scriptsize
    \begin{gather*}
    % Solution
    \vec{s}^T = \left( \vec{u} \quad \vec{\lambda} \right)^T \\
    % Elasticity
    \tensor{\nabla} \cdot \tensor{\sigma}(\vec{u}) = \vec{0} \\
    % Dirichlet
    u_x = 0 \text{ on boundary\_xneg} \\
    u_x = 0 \text{ on boundary\_xpos} \\
    u_y = 0 \text{ on boundary\_yneg} \\
    % Prescribed slip
    d = d(y) \text{ on fault}
    \end{gather*}}
  \end{minipage}
  \hfill
  \begin{minipage}{0.67\textwidth}
    \includefigure[width=\textwidth]{figs/step05-diagram}
  \end{minipage}
      
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}[t,fragile]
  \frametitle{Step 5a: Physics to simulation parameters}
  \summary{}

  \begin{minipage}[t]{0.3\textwidth}
    {\scriptsize
    \begin{gather*}
    % Solution
    % Solution
    \vec{s}^T = \left( \vec{u} \quad \vec{\lambda} \right)^T \tikzmark{solution5}\\
    % Elasticity
    \tensor{\nabla} \cdot \tensor{\sigma}(\vec{u}) = \vec{0} \tikzmark{material5}\\
    % Dirichlet
    u_x = 0 \text{ on boundary\_xneg} \tikzmark{bc5}\\
    u_x = 0 \text{ on boundary\_xpos} \\
    u_y = 0 \text{ on boundary\_yneg} \\
    % Prescribed slip
    d = d(y) \text{ on fault} \tikzmark{fault5}
    \end{gather*}}
  \end{minipage}
  \hfill
  \begin{minipage}[t]{0.67\textwidth}
    % Solution
    \begin{onlyenv}<2>
      \tikzmark{solution5-cfg}
      \begin{cfgcode}
        # Default values
        [pylithapp.problem]
        solution = pylith.problems.SolnDispLagrange
        defaults.quadrature_order = 1
        
        [pylithapp.problem.solution.subfields]
        displacement.basis_order = 1
        lagrange_multiplier_fault.basis_order = 1
      \end{cfgcode}
    \end{onlyenv}
    %
    % Governing equations
    \begin{onlyenv}<3>
      \tikzmark{material5-cfg}
      \begin{cfgcode}
        [pylithapp.problem]
        materials = [slab, crust, wedge]

        [pylithapp.problem.materials.slab]
        description = Slab material below main fault
        label_value = 1

        db_auxiliary_field = spatialdata.spatialdb.SimpleDB
        db_auxiliary_field.description = Elastic properties for slab
        db_auxiliary_field.iohandler.filename = mat_elastic.spatialdb

        auxiliary_subfields.density.basis_order = 0
        bulk_rheology.auxiliary_subfields.bulk_modulus.basis_order = 0
        bulk_rheology.auxiliary_subfields.shear_modulus.basis_order = 0

        derived_subfields.cauchy_strain.basis_order = 0
        derived_subfields.cauchy_stress.basis_order = 0
      \end{cfgcode}
    \end{onlyenv}
    %
    % Boundary conditions
    \begin{onlyenv}<4>
      \tikzmark{bc5-cfg}
      \begin{cfgcode}
        bc = [bc_xneg, bc_xpos, bc_yneg]
        bc.bc_xneg = pylith.bc.DirichletTimeDependent
        bc.bc_xpos = pylith.bc.DirichletTimeDependent
        bc.bc_yneg = pylith.bc.DirichletTimeDependent
        
        [pylithapp.problem.bc.bc_xpos]
        label = boundary_xpos
        label_value = 11
        constrained_dof = [0]
        db_auxiliary_field = pylith.bc.ZeroDB
        db_auxiliary_field.description = Dirichlet BC +x edge

        auxiliary_subfields.initial_amplitude.basis_order = 0 
      \end{cfgcode}
    \end{onlyenv}
    %
    % Fault
    \begin{onlyenv}<5>
      \tikzmark{fault5-cfg}
      \begin{cfgcode}
        [pylithapp.problem]
        interfaces = [fault]

        [pylithapp.problem.interfaces.fault]
        label = fault
        label_value = 20
        edge = fault_end
        edge_value = 21
        observers.observer.data_fields = [slip, traction_change]

        [pylithapp.problem.interfaces.fault.eq_ruptures.rupture]
        db_auxiliary_field = spatialdata.spatialdb.UniformDB
        db_auxiliary_field.description = Fault rupture auxiliary field spatial database
        db_auxiliary_field.values = [initiation_time, final_slip_left_lateral, final_slip_opening]
        db_auxiliary_field.data = [0.0*s, -2.0*m, 0.0*m]
      \end{cfgcode}
    \end{onlyenv}
  \end{minipage}

  \begin{tikzpicture}[overlay,remember picture]
    \draw[physics-arrow,visible on=<2>] ($(pic cs:solution5-cfg)-(0,2em)$) to (pic cs:solution5);
    \draw[physics-arrow,visible on=<3>] ($(pic cs:material5-cfg)-(0,2em)$) to (pic cs:material5);
    \draw[physics-arrow,visible on=<4>] ($(pic cs:bc5-cfg)-(0,2em)$) to (pic cs:bc5);
    \draw[physics-arrow,visible on=<5>] ($(pic cs:fault5-cfg)-(0,2em)$) to (pic cs:fault5);
  \end{tikzpicture}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 5a: Input files}
  \summary{}

  \begin{description}
  \item[mesh\_tri.msh] Finite-element mesh generated using Gmsh
  \item[pylithapp.cfg] PyLith parameter file common to all steps
  \item[step05a\_onefault.cfg] PyLith parameter file
  \item[mat\_elastic.spatialdb] Spatial database for isotropic linear elastic properties
  \end{description}
    
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}[fragile]
  \frametitle{Step 5a: Run the simulation}
  \summary{}

\begin{bashcode}
pylith step05a_onefault.cfg

# Output
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/apps/PyLithApp.py:77:main
 -- pylithapp(info)
 -- Running on 1 process(es).
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/meshio/MeshIOObj.py:38:read
 -- meshiopetsc(info)
 -- Reading finite-element mesh

# -- many lines omitted --

 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/problems/TimeDependent.py:132:run
 -- timedependent(info)
 -- Solving problem.
0 TS dt 0.01 time 0.
    0 SNES Function norm 3.227923200129e-02
      Linear solve converged due to CONVERGED_ATOL iterations 19
    1 SNES Function norm 2.108001034238e-12
    Nonlinear solve converged due to CONVERGED_FNORM_ABS iterations 1
1 TS dt 0.01 time 0.01
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/problems/Problem.py:199:finalize
 -- timedependent(info)
 -- Finalizing problem.
\end{bashcode}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 5a: Visualize results}
  \summary{{\tt pylith\_viz --filenames=\ldots\ warp\_grid --component=x --exaggeration=3000}}

  \includefigure[height=7.0cm]{figs/step05a-solution}
    
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 5a: Visualize results}
  \summary{{\tt pylith\_viz --filenames=\ldots\ warp\_grid --field=cauchy\_stress --component=xy --exaggeration=3000}}

  \includefigure[height=7.0cm]{figs/step05a-stress}
    
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}[t,fragile]
  \frametitle{Step 5b: Physics to simulation parameters}
  \summary{}

  \begin{minipage}[t]{0.3\textwidth}
    {\scriptsize
    \begin{gather*}
    % Solution
    % Solution
    \vec{s}^T = \left( \vec{u} \quad \vec{\lambda} \right)^T \tikzmark{solution5}\\
    % Elasticity
    \tensor{\nabla} \cdot \tensor{\sigma}(\vec{u}) = \vec{0} \tikzmark{material5}\\
    % Dirichlet
    u_x = 0 \text{ on boundary\_xneg} \tikzmark{bc5}\\
    u_x = 0 \text{ on boundary\_xpos} \\
    u_y = 0 \text{ on boundary\_yneg} \\
    % Prescribed slip
    d = d(y) \text{ on fault} \tikzmark{fault5}
    \end{gather*}}
  \end{minipage}
  \hfill
  \begin{minipage}[t]{0.67\textwidth}
    % Solution
    \begin{onlyenv}<2>
      \tikzmark{solution5-cfg}
      \begin{cfgcode}
        # Refine to decrease discretization size by a factor of 2
        [pylithapp.mesh_generator]
        refiner = pylith.topology.RefineUniform
      \end{cfgcode}
    \end{onlyenv}
  \end{minipage}

  \begin{tikzpicture}[overlay,remember picture]
    \draw[physics-arrow,visible on=<2>] ($(pic cs:solution5-cfg)-(0,2em)$) to (pic cs:solution5);
  \end{tikzpicture}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}[fragile]
  \frametitle{Step 5b: Run the simulation}
  \summary{}

\begin{bashcode}
pylith step05b_onefault.cfg

# Output
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/apps/PyLithApp.py:77:main
 -- pylithapp(info)
 -- Running on 1 process(es).
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/meshio/MeshIOObj.py:38:read
 -- meshiopetsc(info)
 -- Reading finite-element mesh

# -- many lines omitted --

 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/problems/TimeDependent.py:132:run
 -- timedependent(info)
 -- Solving problem.
0 TS dt 0.01 time 0.
    0 SNES Function norm 2.318454436244e-02
      Linear solve converged due to CONVERGED_ATOL iterations 28
    1 SNES Function norm 3.219580962017e-12
    Nonlinear solve converged due to CONVERGED_FNORM_ABS iterations 1
1 TS dt 0.01 time 0.01
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/problems/Problem.py:199:finalize
 -- timedependent(info)
 -- Finalizing problem.
\end{bashcode}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 5b: Visualize results}
  \summary{{\tt pylith\_viz --filenames=\ldots\ warp\_grid --component=x --exaggeration=3000}}

  \includefigure[height=7.0cm]{figs/step05b-solution}
    
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 5b: Visualize results}
  \summary{{\tt pylith\_viz --filenames=\ldots\ warp\_grid --field=cauchy\_stress --component=xy --exaggeration=3000}}

  \includefigure[height=7.0cm]{figs/step05b-stress}
    
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}[t,fragile]
  \frametitle{Step 5c: Physics to simulation parameters}
  \summary{}

  \begin{minipage}[t]{0.3\textwidth}
    {\scriptsize
    \begin{gather*}
    % Solution
    % Solution
    \vec{s}^T = \left( \vec{u} \quad \vec{\lambda} \right)^T \tikzmark{solution5}\\
    % Elasticity
    \tensor{\nabla} \cdot \tensor{\sigma}(\vec{u}) = \vec{0} \tikzmark{material5}\\
    % Dirichlet
    u_x = 0 \text{ on boundary\_xneg} \tikzmark{bc5}\\
    u_x = 0 \text{ on boundary\_xpos} \\
    u_y = 0 \text{ on boundary\_yneg} \\
    % Prescribed slip
    d = d(y) \text{ on fault} \tikzmark{fault5}
    \end{gather*}}
  \end{minipage}
  \hfill
  \begin{minipage}[t]{0.67\textwidth}
    % Solution
    \begin{onlyenv}<2>
      \tikzmark{solution5-cfg}
      \begin{cfgcode}
        [pylithapp.problem]
        solution = pylith.problems.SolnDispLagrange
        defaults.quadrature_order = 2

        [pylithapp.problem.solution.subfields]
        displacement.basis_order = 2
        lagrange_multiplier_fault.basis_order = 2

        [pylithapp.problem.materials.slab]
        derived_subfields.cauchy_strain.basis_order = 1
        derived_subfields.cauchy_stress.basis_order = 1

        [pylithapp.problem.materials.crust]
        derived_subfields.cauchy_strain.basis_order = 1
        derived_subfields.cauchy_stress.basis_order = 1

        [pylithapp.problem.materials.wedge]
        derived_subfields.cauchy_strain.basis_order = 1
        derived_subfields.cauchy_stress.basis_order = 1
      \end{cfgcode}
    \end{onlyenv}
  \end{minipage}

  \begin{tikzpicture}[overlay,remember picture]
    \draw[physics-arrow,visible on=<2>] ($(pic cs:solution5-cfg)-(0,2em)$) to (pic cs:solution5);
  \end{tikzpicture}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}[fragile]
  \frametitle{Step 5c: Run the simulation}
  \summary{}

\begin{bashcode}
pylith step05c_onefault.cfg

# Output
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/apps/PyLithApp.py:77:main
 -- pylithapp(info)
 -- Running on 1 process(es).
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/meshio/MeshIOObj.py:38:read
 -- meshiopetsc(info)
 -- Reading finite-element mesh

# -- many lines omitted --

 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/problems/TimeDependent.py:132:run
 -- timedependent(info)
 -- Solving problem.
0 TS dt 0.01 time 0.
    0 SNES Function norm 2.466334009308e-02
      Linear solve converged due to CONVERGED_ATOL iterations 34
    1 SNES Function norm 1.331365802636e-12
    Nonlinear solve converged due to CONVERGED_FNORM_ABS iterations 1
1 TS dt 0.01 time 0.01
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/problems/Problem.py:199:finalize
 -- timedependent(info)
 -- Finalizing problem.
\end{bashcode}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 5c: Visualize results}
  \summary{{\tt pylith\_viz --filenames=\ldots\ warp\_grid --component=x --exaggeration=3000}}

  \includefigure[height=7.0cm]{figs/step05c-solution}
    
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 5c: Visualize results}
  \summary{{\tt pylith\_viz --filenames=\ldots\ warp\_grid --field=cauchy\_stress --component=xy --exaggeration=3000}}

  \includefigure[height=7.0cm]{figs/step05c-stress}
    
\end{frame}


% ========================================================== SECTION
\subsection{step06-twofaults-elastic}

% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 6: Overview}
  \summary{Uniform rupture on two faults (different origin times) with Dirichlet (displacement) boundary conditions}

  \includefigure[height=6.5cm]{figs/step06-diagram}
      
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 6: Physics}
  \summary{}

  \begin{minipage}{0.3\textwidth}
    {\scriptsize
    \begin{gather*}
    % Solution
    \vec{s}^T = \left( \vec{u} \quad \vec{\lambda} \right)^T \\
    % Elasticity
    \tensor{\nabla} \cdot \tensor{\sigma}(\vec{u}) = \vec{0} \\
    % Dirichlet
    u_x = 0 \text{ on boundary\_xneg} \\
    u_x = 0 \text{ on boundary\_xpos} \\
    u_y = 0 \text{ on boundary\_yneg} \\
    % Prescribed slip
    d = d(y) \text{ on fault} \\
    d = d(y) \text{ on splay}
    \end{gather*}}
  \end{minipage}
  \hfill
  \begin{minipage}{0.67\textwidth}
    \includefigure[width=\textwidth]{figs/step06-diagram}
  \end{minipage}
      
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}[t,fragile]
  \frametitle{Step 6: Physics to simulation parameters}
  \summary{}

  \begin{minipage}[t]{0.3\textwidth}
    {\scriptsize
    \begin{gather*}
    % Solution
    % Solution
    \vec{s}^T = \left( \vec{u} \quad \vec{\lambda} \right)^T \tikzmark{solution6}\\
    % Elasticity
    \tensor{\nabla} \cdot \tensor{\sigma}(\vec{u}) = \vec{0} \tikzmark{material6}\\
    % Dirichlet
    u_x = 0 \text{ on boundary\_xneg} \tikzmark{bc6}\\
    u_x = 0 \text{ on boundary\_xpos} \\
    u_y = 0 \text{ on boundary\_yneg} \\
    % Prescribed slip
    d = d(y) \text{ on fault} \tikzmark{fault6} \\
    d = d(y) \text{ on splay}
    \end{gather*}}
  \end{minipage}
  \hfill
  \begin{minipage}[t]{0.67\textwidth}
    % Solution
    \begin{onlyenv}<2>
      \tikzmark{solution6-cfg}
      \begin{cfgcode}
        [pylithapp.timedependent]
        initial_dt = 20.0*year
        start_time = -20.0*year
        end_time = 40.0*year

        # Same as Step 5b
        [pylithapp.mesh_generator]
        refiner = pylith.topology.RefineUniform
      \end{cfgcode}
    \end{onlyenv}
    %
    % Governing equations
    \begin{onlyenv}<3>
      \tikzmark{material6-cfg}
      \begin{cfgcode}
        # Same as Step 5
      \end{cfgcode}
    \end{onlyenv}
    %
    % Boundary conditions
    \begin{onlyenv}<4>
      \tikzmark{bc6-cfg}
      \begin{cfgcode}
        # Same as Step 5
      \end{cfgcode}
    \end{onlyenv}
    %
    % Fault
    \begin{onlyenv}<5>
      \tikzmark{fault6-cfg}
      \begin{cfgcode}
        [pylithapp.problem]
        interfaces = [fault, splay]

        [pylithapp.problem.interfaces.fault]
        label = fault
        label_value = 20
        edge = fault_end
        edge_value = 21
        observers.observer.data_fields = [slip]

        [pylithapp.problem.interfaces.fault.eq_ruptures.rupture]
        origin_time = 0.0*year
        db_auxiliary_field = spatialdata.spatialdb.UniformDB
        db_auxiliary_field.description = Fault rupture auxiliary field spatial database
        db_auxiliary_field.values = [initiation_time, final_slip_left_lateral, final_slip_opening]
        db_auxiliary_field.data = [0.0*s, -2.0*m, 0.0*m]
      \end{cfgcode}
    \end{onlyenv}
  \end{minipage}

  \begin{tikzpicture}[overlay,remember picture]
    \draw[physics-arrow,visible on=<2>] ($(pic cs:solution6-cfg)-(0,2em)$) to (pic cs:solution6);
    \draw[physics-arrow,visible on=<3>] ($(pic cs:material6-cfg)-(0,2em)$) to (pic cs:material6);
    \draw[physics-arrow,visible on=<4>] ($(pic cs:bc6-cfg)-(0,2em)$) to (pic cs:bc6);
    \draw[physics-arrow,visible on=<5>] ($(pic cs:fault6-cfg)-(0,2em)$) to (pic cs:fault6);
  \end{tikzpicture}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 6: Input files}
  \summary{}

  \begin{description}
  \item[mesh\_tri.msh] Finite-element mesh generated using Gmsh
  \item[pylithapp.cfg] PyLith parameter file common to all steps
  \item[step06\_twofaults\_elastic.cfg] PyLith parameter file
  \item[mat\_elastic.spatialdb] Spatial database for isotropic linear elastic properties
  \end{description}
    
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}[fragile]
  \frametitle{Step 6: Run the simulation}
  \summary{}

\begin{bashcode}
pylith step06_twofaults_elastic.cfg

# Output
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/apps/PyLithApp.py:77:main
 -- pylithapp(info)
 -- Running on 1 process(es).
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/meshio/MeshIOObj.py:38:read
 -- meshiopetsc(info)
 -- Reading finite-element mesh

# -- many lines omitted --

1 TS dt 0.2 time 0.
    0 SNES Function norm 1.471077126699e-12
    Nonlinear solve converged due to CONVERGED_FNORM_ABS iterations 0
2 TS dt 0.2 time 0.2
    0 SNES Function norm 8.112736904302e-03
      Linear solve converged due to CONVERGED_ATOL iterations 22
    1 SNES Function norm 1.506999209164e-12
    Nonlinear solve converged due to CONVERGED_FNORM_ABS iterations 1
3 TS dt 0.2 time 0.4
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/problems/Problem.py:199:finalize
 -- timedependent(info)
 -- Finalizing problem.
\end{bashcode}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 6: Visualize results}
  \summary{{\tt pylith\_viz --filenames=\ldots\ warp\_grid --component=x}}

  \includefigure[height=7.0cm]{figs/step06-solution}
    
\end{frame}


% ========================================================== SECTION
\subsection{step07-twofaults-maxwell}

% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 7: Overview}
  \summary{Uniform rupture on two faults with Dirichlet (displacement) boundary conditions}

  Same as Step 6 with finer time steps and linear Maxwell viscoelastic bulk rheology for the slab.
      
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}[t,fragile]
  \frametitle{Step 7: Physics to simulation parameters}
  \summary{}

  \begin{minipage}[t]{0.3\textwidth}
    {\scriptsize
    \begin{gather*}
    % Solution
    \vec{s}^T = \left( \vec{u} \quad \vec{\lambda} \right)^T \tikzmark{solution7}\\
    % Elasticity
    \tensor{\nabla} \cdot \tensor{\sigma}(\vec{u}) = \vec{0} \tikzmark{material7}\\
    \rho, v_p, v_s \text{ in crust and wedge} \\
    \rho, v_p, v_s, \nu  \text{ in slab} \\
    % Dirichlet
    u_x = 0 \text{ on boundary\_xneg} \tikzmark{bc7}\\
    u_x = 0 \text{ on boundary\_xpos} \\
    u_y = 0 \text{ on boundary\_yneg} \\
    % Prescribed slip
    d = d(y) \text{ on fault} \tikzmark{fault7} \\
    d = d(y) \text{ on splay}
    \end{gather*}}
  \end{minipage}
  \hfill
  \begin{minipage}[t]{0.67\textwidth}
    % Solution
    \begin{onlyenv}<2>
      \tikzmark{solution7-cfg}
      \begin{cfgcode}
        [pylithapp.problem]
        initial_dt = 4.0*year
        start_time = -4.0*year
        end_time = 100.0*year

        normalizer.relaxation_time = 20.0*year
      \end{cfgcode}
    \end{onlyenv}
    %
    % Governing equations
    \begin{onlyenv}<3>
      \tikzmark{material7-cfg}
      \begin{cfgcode}
        [pylithapp.problem.materials.slab]
        description = Slab material below main fault
        label_value = 1
        bulk_rheology = pylith.materials.IsotropicLinearMaxwell

        db_auxiliary_field = spatialdata.spatialdb.SimpleDB
        db_auxiliary_field.description = Elastic properties for slab
        db_auxiliary_field.iohandler.filename = mat_maxwell.spatialdb

        auxiliary_subfields.density.basis_order = 0
        bulk_rheology.auxiliary_subfields.bulk_modulus.basis_order = 0
        bulk_rheology.auxiliary_subfields.shear_modulus.basis_order = 0
        bulk_rheology.auxiliary_subfields.maxwell_time.basis_order = 0
        
        derived_subfields.cauchy_strain.basis_order = 0
        derived_subfields.cauchy_stress.basis_order = 0
      \end{cfgcode}
    \end{onlyenv}
    %
    % Boundary conditions
    \begin{onlyenv}<4>
      \tikzmark{bc7-cfg}
      \begin{cfgcode}
        # Same as Step 6
      \end{cfgcode}
    \end{onlyenv}
    %
    % Fault
    \begin{onlyenv}<5>
      \tikzmark{fault7-cfg}
      \begin{cfgcode}
        # Same as Step 6
      \end{cfgcode}
    \end{onlyenv}
  \end{minipage}

  \begin{tikzpicture}[overlay,remember picture]
    \draw[physics-arrow,visible on=<2>] ($(pic cs:solution7-cfg)-(0,2em)$) to (pic cs:solution7);
    \draw[physics-arrow,visible on=<3>] ($(pic cs:material7-cfg)-(0,2em)$) to (pic cs:material7);
    \draw[physics-arrow,visible on=<4>] ($(pic cs:bc7-cfg)-(0,2em)$) to (pic cs:bc7);
    \draw[physics-arrow,visible on=<5>] ($(pic cs:fault7-cfg)-(0,2em)$) to (pic cs:fault7);
  \end{tikzpicture}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 7: Input files}
  \summary{}

  \begin{description}
  \item[mesh\_tri.msh] Finite-element mesh generated using Gmsh
  \item[pylithapp.cfg] PyLith parameter file common to all steps
  \item[step07\_twofaults\_maxwell.cfg] PyLith parameter file
  \item[mat\_elastic.spatialdb] Spatial database for isotropic linear elastic properties
  \item[mat\_maxwell.spatialdb] Spatial database for isotropic linear Maxwell properties
  \end{description}
    
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}[fragile]
  \frametitle{Step 7: Run the simulation}
  \summary{}

\begin{bashcode}
pylith step07_twofaults_maxwell.cfg

# Output
 >> /software/unix/py39-venv/pylith-debug/lib/python3.9/site-packages/pylith/meshio/MeshIOObj.py:44:read
 -- meshiopetsc(info)
 -- Reading finite-element mesh
 >> /src/cig/pylith/libsrc/pylith/meshio/MeshIO.cc:94:void pylith::meshio::MeshIO::read(pylith::topology::Mesh*)
 -- meshiopetsc(info)
 -- Component 'reader': Domain bounding box:
    (-100000, 100000)
    (-100000, 0)

# -- many lines omitted --

25 TS dt 0.2 time 4.8
    0 SNES Function norm 2.513157249301e-05
      Linear solve converged due to CONVERGED_ATOL iterations 4
    1 SNES Function norm 1.365880183111e-12
    Nonlinear solve converged due to CONVERGED_FNORM_ABS iterations 1
26 TS dt 0.2 time 5.
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/problems/Problem.py:199:finalize
 -- timedependent(info)
 -- Finalizing problem.
\end{bashcode}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 7: Visualize results}
  \summary{{\tt pylith\_viz --filenames=\ldots\ warp\_grid --component=x}}

  \includefigure[height=7.0cm]{figs/step07-solution}
    
\end{frame}



% ======================================================================
\end{document}


% End of file
