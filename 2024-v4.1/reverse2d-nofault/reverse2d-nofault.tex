% -*- TeX -*-
\documentclass[aspectratio=169]{beamer}

\title{PyLith v4.1 Tutorial}
\subtitle{Gravitational Body Forces and Surface Loading}
\author{Charles Williams \\
  Brad Aagaard \\
  Matthew Knepley}
\institute{\includegraphics[scale=1.5]{../../logos/cig_logo_dots}%
  \hspace{4em}%
\raisebox{1em}{\includegraphics[scale=1.0]{../../logos/cig_short_pylith}}}
\date{June 10, 2024}


% ---------------------------------------------------- CUSTOMIZATION
\usetheme{CIG}
\input{../style}

% ========================================================= DOCUMENT
\begin{document}

% ------------------------------------------------------------ SLIDE
\maketitle

\logo{\includegraphics[height=4.5ex]{../../logos/cig_short_pylith}}

% ========================================================== SECTION
\section{{\ttfamily examples/reverse-2d}}
\subsection{Overview}

% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Vertical Cross-Section of Reverse Fault (2D): {\ttfamily examples/reverse-2d}}
  \summary{}

  \includefigure[height=6.1cm]{figs/geometry}

\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Steps in example}
  \summary{Steps 5-7 are covered in the elasticity with prescribed slip tutorial}

  \begin{description}
    \item[Step 1] \highlight{Gravitational body forces and linear isotropic elasticity}
    \item[Step 2] \highlight{Gravitational body forces and linear isotropic elasticity with a reference stress state}
    \item[Step 3] \highlight{Gravitational body forces and linear isotropic incompressible elasticity}
    \item[Step 4] \highlight{Surface tractions and linear isotropic linear elasticity}
    \item[Step 5] Earthquake rupture on one fault and linear isotropic linear elasticity
    \item[Step 6] Earthquake rupture on two faults and linear isotropic linear elasticity
    \item[Step 7] Same as Step 6 but time-dependent with linear isotropic Maxwell viscoelastic rheology
    \item[Step 8] Same as Step 7 but with linear isotropic power-law viscoelastic rheology
  \end{description}
  
\end{frame}

% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Concepts covered}
  \summary{}

  \begin{itemize}
  \item When are gravitational body forces necessary?
  \item Gravitational body forces in 2D
  \item Reference stresses to balance body forces
  \item Incompressible elasticity to achieve a reference state
  \item Traction boundary conditions to represent a surface load
  \end{itemize}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Overview of a PyLith simulation}
  \summary{}

  \includefigure[height=7.0cm]{figs/pylith_simulation}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Files used in simulations}
  \summary{Files are in directory {\tt examples/reverse-2d}}

  \begin{description}
  \item[README.md] Brief description of the various examples
  \item[*.cfg] PyLith parameter files
  \item[generate\_gmsh.py] Python script to generate mesh using Gmsh
  \item[*.msh] Finite-element mesh files generated by Gmsh
  \item[*.spatialdb] Spatial database files
  \item[output] Directory containing simulation output; created automatically when running the simulations
  \end{description}

\end{frame}


% ========================================================== SUBSECTION
\subsection{Finite-Element Mesh}

% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Geometry}
  \summary{}

  \includefigure[height=7.0cm]{figs/geometry}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Creating the finite-element mesh with Gmsh}
  \summary{}

  We construct the geometry by first creating points, then connecting the points into curves, and finally the curves into surfaces.
  
  \includefigure[height=6.5cm]{figs/geometry-gmsh}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Gmsh: Creating the finite-element mesh}
  \summary{}
  
  \begin{itemize}
  \item Each curve in Gmsh has a direction (orientation).
  \item The direction is from the starting point to the ending point.
  \item When connecting curves into surfaces, you must connect the curves in a consistent direction.
  \item We connect the curves in a counter-clockwise direction.
  \item To reverse the direction of a curve, use the negative tag.
  \end{itemize}
  
\end{frame}

% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Gmsh: Finite-Element Mesh}
  \summary{{\tt ./generate\_gmsh.py --write --gui}}

  \includefigure[height=7.0cm]{figs/gmsh-tri}
  
\end{frame}


% ========================================================== SECTION
\subsection{step01-gravity}

% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{When Do We Need to Use Gravitational Stresses?}
  \summary{}

  \begin{itemize}
  \item Pressure/stress-dependent rheology
    \begin{itemize}
    \item Pressure-dependent bulk rheology (for example, plasticity)
    \item Stress-dependent fault rheology (for example, friction)
    \end{itemize}
  \item Viscoelastic simulations in which we care about vertical deformation
  \item Other simulations in which we care about the absolute stress state
  \end{itemize}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 1a: Overview}
  \summary{Gravitational body forces applied to elastic material}

  \includefigure[height=6.5cm]{figs/step01-diagram}
      
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 1a: Physics}
  \summary{}

  \begin{minipage}{0.3\textwidth}
    {\scriptsize
    \begin{gather*}
    % Solution
    \vec{s} = \left(\begin{array}{c} \vec{u} \end{array}\right)^T \\
    % Elasticity
    \rho(\vec{x}) \vec{g} + \tensor{\nabla} \cdot \tensor{\sigma}(\vec{u}) = \vec{0} \\
    % Dirichlet
    u_x = 0 \text{ on boundary\_xneg} \\
    u_x = 0 \text{ on boundary\_xpos} \\
    u_y = 0 \text{ on boundary\_yneg} \\
    \end{gather*}}
  \end{minipage}
  \hfill
  \begin{minipage}{0.67\textwidth}
    \includefigure[width=\textwidth]{figs/step01-diagram}
  \end{minipage}
      
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}[t,fragile]
  \frametitle{Step 1a: Physics to simulation parameters}
  \summary{}

  \begin{minipage}[t]{0.3\textwidth}
    {\scriptsize
    \begin{gather*}
    % Solution
    \vec{s} = \left(\begin{array}{c} \vec{u} \end{array}\right)^T \tikzmark{solution1}\\
    % Elasticity
    \rho(\vec{x}) \vec{g} + \tensor{\nabla} \cdot \tensor{\sigma}(\vec{u}) = \vec{0} \tikzmark{material1}\\
    % Dirichlet
    u_x = 0 \text{ on boundary\_xneg} \tikzmark{bc1}\\
    u_x = 0 \text{ on boundary\_xpos} \\
    u_y = 0 \text{ on boundary\_yneg} \\
    \end{gather*}}
  \end{minipage}
  \hfill
  \begin{minipage}[t]{0.67\textwidth}
    % Solution
    \begin{onlyenv}<2>
      \tikzmark{solution1-cfg}
      \begin{cfgcode}
        # Default values
        [pylithapp.problem]
        solution = pylith.problems.SolnDisp
        defaults.quadrature_order = 1
        
        [pylithapp.problem.solution.subfields]
        displacement.basis_order = 1
      \end{cfgcode}
    \end{onlyenv}
    %
    % Governing equations
    \begin{onlyenv}<3>
      \tikzmark{material1-cfg}
      \begin{cfgcode}
        [pylithapp.problem]
        gravity_field = spatialdata.spatialdb.GravityField
        gravity_field.gravity_dir = [0.0, -1.0, 0.0]
      \end{cfgcode}
    \end{onlyenv}
    %
    % Boundary conditions
    \begin{onlyenv}<4>
      \tikzmark{bc1-cfg}
      \begin{cfgcode}
        bc = [bc_xneg, bc_xpos, bc_yneg]
        bc.bc_xneg = pylith.bc.DirichletTimeDependent
        bc.bc_xpos = pylith.bc.DirichletTimeDependent
        bc.bc_yneg = pylith.bc.DirichletTimeDependent
        
        [pylithapp.problem.bc.bc_xpos]
        label = boundary_xpos
        label_value = 11
        constrained_dof = [0]
        db_auxiliary_field = pylith.bc.ZeroDB
        db_auxiliary_field.description = Dirichlet BC +x edge

        auxiliary_subfields.initial_amplitude.basis_order = 0 
      \end{cfgcode}
    \end{onlyenv}
  \end{minipage}

  \begin{tikzpicture}[overlay,remember picture]
    \draw[physics-arrow,visible on=<2>] ($(pic cs:solution1-cfg)-(0,2em)$) to (pic cs:solution1);
    \draw[physics-arrow,visible on=<3>] ($(pic cs:material1-cfg)-(0,2em)$) to (pic cs:material1);
    \draw[physics-arrow,visible on=<4>] ($(pic cs:bc1-cfg)-(0,2em)$) to (pic cs:bc1);
  \end{tikzpicture}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 1a: Input files}
  \summary{}

  \begin{description}
  \item[mesh\_tri.msh] Finite-element mesh generated using Gmsh
  \item[pylithapp.cfg] PyLith parameter file common to all steps
  \item[step01a\_gravity.cfg] PyLith parameter file
  \item[mat\_elastic.spatialdb] Spatial database for isotropic linear elastic properties
  \end{description}
    
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}[fragile]
  \frametitle{Step 1a: Run the simulation}
  \summary{}

\begin{bashcode}
pylith step01a_gravity.cfg

# Output
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/apps/PyLithApp.py:77:main
 -- pylithapp(info)
 -- Running on 1 process(es).
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/meshio/MeshIOObj.py:38:read
 -- meshiopetsc(info)
 -- Reading finite-element mesh

# -- many lines omitted --

 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/problems/TimeDependent.py:132:run
 -- timedependent(info)
 -- Solving problem.
0 TS dt 0.01 time 0.
    0 SNES Function norm 1.002609960440e+00
      Linear solve converged due to CONVERGED_ATOL iterations 1
    1 SNES Function norm 4.010961748540e-14
    Nonlinear solve converged due to CONVERGED_FNORM_ABS iterations 1
1 TS dt 0.01 time 0.01
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/problems/Problem.py:199:finalize
 -- timedependent(info)
 -- Finalizing problem.
\end{bashcode}
  
\end{frame}


% ------------------------------------------------------------ SLIDE

\begin{frame}
  \frametitle{Step 1a: Visualize results}
  \summary{{\tt pylith\_viz --filenames=output/step01a\_gravity-domain.h5 warp\_grid --exaggeration=5}}

  \includefigure[height=7.0cm]{figs/step01a-solution}
    
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 1a: Visualize results}
  \summary{{\tt pylith\_viz --filenames=\ldots\ warp\_grid --field=cauchy\_stress --component=xy --exaggeration=5}}

  \includefigure[height=7.0cm]{figs/step01a-stress}
    
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}[t,fragile]
  \frametitle{Step 1b: Physics to simulation parameters}
  \summary{}

  \begin{minipage}[t]{0.3\textwidth}
    {\scriptsize
    \begin{gather*}
    % Solution
    \vec{s} = \left(\begin{array}{c} \vec{u} \end{array}\right)^T \tikzmark{solution1}\\
    % Elasticity
    \rho(\vec{x}) \vec{g} + \tensor{\nabla} \cdot \tensor{\sigma}(\vec{u}) = \vec{0} \tikzmark{material1}\\
    % Dirichlet
    u_x = 0 \text{ on boundary\_xneg} \tikzmark{bc1}\\
    u_x = 0 \text{ on boundary\_xpos} \\
    u_y = 0 \text{ on boundary\_yneg} \\
    \end{gather*}}
  \end{minipage}
  \hfill
  \begin{minipage}[t]{0.67\textwidth}
    % Solution
    \begin{onlyenv}<2>
      \tikzmark{solution1-cfg}
      \begin{cfgcode}
        # Refine to decrease discretization size by a factor of 2
        [pylithapp.mesh_generator]
        refiner = pylith.topology.RefineUniform
      \end{cfgcode}
    \end{onlyenv}
  \end{minipage}

  \begin{tikzpicture}[overlay,remember picture]
    \draw[physics-arrow,visible on=<2>] ($(pic cs:solution1-cfg)-(0,2em)$) to (pic cs:solution1);
  \end{tikzpicture}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}[fragile]
  \frametitle{Step 1b: Run the simulation}
  \summary{}

\begin{bashcode}
pylith step01b_gravity.cfg

# Output
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/apps/PyLithApp.py:77:main
 -- pylithapp(info)
 -- Running on 1 process(es).
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/meshio/MeshIOObj.py:38:read
 -- meshiopetsc(info)
 -- Reading finite-element mesh

# -- many lines omitted --

 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/problems/TimeDependent.py:132:run
 -- timedependent(info)
 -- Solving problem.
0 TS dt 0.01 time 0.
    0 SNES Function norm 5.201675538920e-01
      Linear solve converged due to CONVERGED_ATOL iterations 1
    1 SNES Function norm 9.260131489264e-14
    Nonlinear solve converged due to CONVERGED_FNORM_ABS iterations 1
1 TS dt 0.01 time 0.01
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/problems/Problem.py:199:finalize
 -- timedependent(info)
 -- Finalizing problem.
\end{bashcode}
  
\end{frame}


% ------------------------------------------------------------ SLIDE

\begin{frame}
  \frametitle{Step 1b: Visualize results}
  \summary{{\tt pylith\_viz --filenames=output/step01b\_gravity-domain.h5 warp\_grid --exaggeration=5}}

  \includefigure[height=7.0cm]{figs/step01b-solution}
    
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 1b: Visualize results}
  \summary{{\tt pylith\_viz --filenames=\ldots\ warp\_grid --field=cauchy\_stress --component=xy --exaggeration=5}}

  \includefigure[height=7.0cm]{figs/step01b-stress}
    
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}[t,fragile]
  \frametitle{Step 1c: Physics to simulation parameters}
  \summary{}

  \begin{minipage}[t]{0.3\textwidth}
    {\scriptsize
    \begin{gather*}
    % Solution
    \vec{s} = \left(\begin{array}{c} \vec{u} \end{array}\right)^T \tikzmark{solution1}\\
    % Elasticity
    \rho(\vec{x}) \vec{g} + \tensor{\nabla} \cdot \tensor{\sigma}(\vec{u}) = \vec{0} \tikzmark{material1}\\
    % Dirichlet
    u_x = 0 \text{ on boundary\_xneg} \tikzmark{bc1}\\
    u_x = 0 \text{ on boundary\_xpos} \\
    u_y = 0 \text{ on boundary\_yneg} \\
    \end{gather*}}
  \end{minipage}
  \hfill
  \begin{minipage}[t]{0.67\textwidth}
    % Solution
    \begin{onlyenv}<2>
      \tikzmark{solution1-cfg}
      \begin{cfgcode}
        # Increase basis order from 1 (default) to 2
        [pylithapp.problem]
        solution = pylith.problems.SolnDisp
        defaults.quadrature_order = 2
        
        [pylithapp.problem.solution.subfields]
        displacement.basis_order = 2
      \end{cfgcode}
    \end{onlyenv}
  \end{minipage}

  \begin{tikzpicture}[overlay,remember picture]
    \draw[physics-arrow,visible on=<2>] ($(pic cs:solution1-cfg)-(0,2em)$) to (pic cs:solution1);
  \end{tikzpicture}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}[fragile]
  \frametitle{Step 1c: Run the simulation}
  \summary{}

\begin{bashcode}
pylith step01c_gravity.cfg

# Output
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/apps/PyLithApp.py:77:main
 -- pylithapp(info)
 -- Running on 1 process(es).
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/meshio/MeshIOObj.py:38:read
 -- meshiopetsc(info)
 -- Reading finite-element mesh

# -- many lines omitted --

 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/problems/TimeDependent.py:132:run
 -- timedependent(info)
 -- Solving problem.
0 TS dt 0.01 time 0.
    0 SNES Function norm 6.077245184729e-01
      Linear solve converged due to CONVERGED_ATOL iterations 1
    1 SNES Function norm 1.142719067266e-13
    Nonlinear solve converged due to CONVERGED_FNORM_ABS iterations 1
1 TS dt 0.01 time 0.01
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/problems/Problem.py:199:finalize
 -- timedependent(info)
 -- Finalizing problem.
\end{bashcode}
  
\end{frame}


% ------------------------------------------------------------ SLIDE

\begin{frame}
  \frametitle{Step 1c: Visualize results}
  \summary{{\tt pylith\_viz --filenames=output/step01c\_gravity-domain.h5 warp\_grid --exaggeration=5}}

  \includefigure[height=7.0cm]{figs/step01c-solution}
    
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 1c: Visualize results}
  \summary{{\tt pylith\_viz --filenames=\ldots\ warp\_grid --field=cauchy\_stress --component=xy --exaggeration=5}}

  \includefigure[height=7.0cm]{figs/step01c-stress}
    
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 1: Key Points}
  \summary{}

  \begin{enumerate}
  \item The displacement field is very similar for the three different discretizations.\pause
  \item We know the vertical displacement in the exact solution depends on the square of the depth $\Rightarrow$ we expect limited accuracy with a basis order of 1.\pause
  \item In the exact solution, the axial components of the Cauchy stress tensor increase linearly with depth, and the xy component of the Cauchy stress is zero.\pause
  \item With the coarse mesh, the shear stress is close to 10 MPa throughout the mesh.\pause
  \item Refining the mesh decreases the magnitude shear stress by about a factor of 2.\pause
  \item Using a basis order of 2 for the solution subfield reduces the magnitude of the shear stress by nearly 10 orders of magnitude!
  \item \highlight{When resolving the stress field components is important, you will likely want to use a basis order of 2 for the displacement solution subfield.}
  \end{enumerate}
  
\end{frame}


% ========================================================== SECTION
\subsection{step02-gravity-refstate}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 2: Physics}
  \summary{}

  \begin{minipage}{0.3\textwidth}
    {\scriptsize
    \begin{gather*}
    % Solution
    \vec{s} = \left(\begin{array}{c} \vec{u} \end{array}\right)^T \\
    % Elasticity
    \rho(\vec{x}) \vec{g} + \tensor{\nabla} \cdot \tensor{\sigma}(\vec{u}) = \vec{0} \tikzmark{material2}\\
    \tensor{\sigma} - \tensor{\sigma}^\mathit{ref} = \tensor{C} : \left(\tensor{\epsilon}-\tensor{\epsilon}^\mathit{ref}\right) \\
    % Dirichlet
    u_x = 0 \text{ on boundary\_xneg} \\
    u_x = 0 \text{ on boundary\_xpos} \\
    u_y = 0 \text{ on boundary\_yneg} \\
    \end{gather*}}
  \end{minipage}
  \hfill
  \begin{minipage}{0.67\textwidth}
    \includefigure[width=\textwidth]{figs/step01-diagram}
  \end{minipage}
      
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}[t,fragile]
  \frametitle{Step 2: Physics to simulation parameters}
  \summary{}

  \begin{minipage}[t]{0.3\textwidth}
    {\scriptsize
    \begin{gather*}
    % Solution
    \vec{s} = \left(\begin{array}{c} \vec{u} \end{array}\right)^T \tikzmark{solution2}\\
    % Elasticity
    \rho(\vec{x}) \vec{g} + \tensor{\nabla} \cdot \tensor{\sigma}(\vec{u}) = \vec{0} \tikzmark{material2}\\
    \tensor{\sigma} - \tensor{\sigma}^\mathit{ref} = \tensor{C} : \left(\tensor{\epsilon}-\tensor{\epsilon}^\mathit{ref}\right) \\
    % Dirichlet
    u_x = 0 \text{ on boundary\_xneg} \tikzmark{bc2}\\
    u_x = 0 \text{ on boundary\_xpos} \\
    u_y = 0 \text{ on boundary\_yneg} \\
    \end{gather*}}
  \end{minipage}
  \hfill
  \begin{minipage}[t]{0.67\textwidth}
    % Solution
    \begin{onlyenv}<2>
      \tikzmark{solution2-cfg}
      \begin{cfgcode}
        [pylithapp.problem]
        defaults.quadrature_order = 2

        [pylithapp.problem.solution.subfields.displacement]
        basis_order = 2
      \end{cfgcode}
    \end{onlyenv}
    %
    % Governing equations
    \begin{onlyenv}<3>
      \tikzmark{material2-cfg}
      \begin{cfgcode}
        [pylithapp.problem.materials.slab]
        db_auxiliary_field.iohandler.filename = mat_gravity_refstate.spatialdb
        db_auxiliary_field.query_type = linear

        bulk_rheology.use_reference_state = True
      \end{cfgcode}
    \end{onlyenv}
    %
    % Boundary conditions
    \begin{onlyenv}<4>
      \tikzmark{bc2-cfg}
      \begin{cfgcode}
        # Same as Step 1
      \end{cfgcode}
    \end{onlyenv}
  \end{minipage}

  \begin{tikzpicture}[overlay,remember picture]
    \draw[physics-arrow,visible on=<2>] ($(pic cs:solution2-cfg)-(0,2em)$) to (pic cs:solution2);
    \draw[physics-arrow,visible on=<3>] ($(pic cs:material2-cfg)-(0,2em)$) to (pic cs:material2);
    \draw[physics-arrow,visible on=<4>] ($(pic cs:bc2-cfg)-(0,2em)$) to (pic cs:bc2);
  \end{tikzpicture}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 2: Input files}
  \summary{}

  \begin{description}
  \item[mesh\_tri.msh] Finite-element mesh generated using Gmsh
  \item[pylithapp.cfg] PyLith parameter file common to all steps
  \item[step02\_gravity\_refstate.cfg] PyLith parameter file
  \item[mat\_gravity\_refstate.spatialdb] Spatial database with elastic properties and reference stress and strain
  \end{description}

  \vfill
  Reference stress
  \begin{equation}
    \sigma_{xx} = \sigma_{yy} = \sigma_{zz} = \int_0^y \rho g \, dy = \rho g y,
  \end{equation}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}[fragile]
  \frametitle{Step 2: Run the simulation}
  \summary{}

\begin{bashcode}
pylith step02_gravity_refstate.cfg

# Output
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/apps/PyLithApp.py:77:main
 -- pylithapp(info)
 -- Running on 1 process(es).
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/meshio/MeshIOObj.py:38:read
 -- meshiopetsc(info)
 -- Reading finite-element mesh

# -- many lines omitted --

 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/problems/TimeDependent.py:132:run
 -- timedependent(info)
 -- Solving problem.
0 TS dt 0.01 time 0.
    0 SNES Function norm 2.202667950718e-15
    Nonlinear solve converged due to CONVERGED_FNORM_ABS iterations 0
1 TS dt 0.01 time 0.01
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/problems/Problem.py:199:finalize
 -- timedependent(info)
 -- Finalizing problem.
WARNING! There are options you set that were not used!
WARNING! could be spelling mistake, etc!
There is one unused database option. It is:
Option left: name:-ksp_converged_reason (no value) source: code
\end{bashcode}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 2: Visualize results}
  \summary{{\tt pylith\_viz --filenames=output/step02\_gravity\_refstate-domain.h5 warp\_grid --exaggeration=5}}

  \includefigure[height=7.0cm]{figs/step02-solution}
    
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 2: Visualize results}
  \summary{{\tt pylith\_viz --filenames=\ldots\ warp\_grid --field=cauchy\_stress --component=xy --exaggeration=5}}

  \includefigure[height=7.0cm]{figs/step02-stress}
    
\end{frame}


% ========================================================== SECTION
\subsection{step03-gravity-incompressible}

% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 3: Physics}
  \summary{}

  \begin{minipage}{0.3\textwidth}
    {\scriptsize
    \begin{gather*}
      % Solution
      \vec{s} = \left( \vec{u} \quad \ p \right)^T, \\
      % Incompressible elasticity
      \rho(\vec{x})\vec{g} + \tensor{\nabla} \cdot \left(\tensor{\sigma}^\mathit{dev}(\vec{u}) - p\tensor{I}\right) = \vec{0} \\
      % Pressure
      \vec{\nabla} \cdot \vec{u} + \frac{p}{K} = 0 \\
      % Dirichlet
      u_x = 0 \text{ on boundary\_xneg} \\
      u_x = 0 \text{ on boundary\_xpos} \\
      u_y = 0 \text{ on boundary\_yneg} \\
      p = 0 \text{ on boundary\_ypos}
    \end{gather*}}
  \end{minipage}
  \hfill
  \begin{minipage}{0.67\textwidth}
    \includefigure[width=\textwidth]{figs/step01-diagram}
  \end{minipage}
      
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}[t,fragile]
  \frametitle{Step 3: Physics to simulation parameters}
  \summary{}

  \begin{minipage}[t]{0.3\textwidth}
    {\scriptsize
    \begin{gather*}
      % Solution
      \vec{s} = \left( \vec{u} \quad \ p \right)^T \tikzmark{solution3}\\
      % Incompressible elasticity
      \rho(\vec{x})\vec{g} + \tensor{\nabla} \cdot \left(\tensor{\sigma}^\mathit{dev}(\vec{u}) - p\tensor{I}\right) = \vec{0} \tikzmark{material3}\\
      % Pressure
      \vec{\nabla} \cdot \vec{u} + \frac{p}{K} = 0 \\
      % Dirichlet
      u_x = 0 \text{ on boundary\_xneg} \tikzmark{bc3}\\
      u_x = 0 \text{ on boundary\_xpos} \\
      u_y = 0 \text{ on boundary\_yneg} \\
      p = 0 \text{ on boundary\_ypos}
    \end{gather*}}
  \end{minipage}
  \hfill
  \begin{minipage}[t]{0.67\textwidth}
    % Solution
    \begin{onlyenv}<2>
      \tikzmark{solution3-cfg}
      \begin{cfgcode}
        [pylithapp.problem]
        solution = pylith.problems.SolnDispPres

        [pylithapp.problem.solution.subfields]
        displacement.basis_order = 1
        pressure.basis_order = 1
      \end{cfgcode}
    \end{onlyenv}
    %
    % Governing equations
    \begin{onlyenv}<3>
      \tikzmark{material3-cfg}
      \begin{cfgcode}
        [pylithapp.problem.materials]
        slab = pylith.materials.IncompressibleElasticity
        crust = pylith.materials.IncompressibleElasticity
        wedge = pylith.materials.IncompressibleElasticity

        [pylithapp.problem.materials.slab]
        db_auxiliary_field.iohandler.filename = mat_elastic_incompressible.spatialdb
      \end{cfgcode}
    \end{onlyenv}
    %
    % Boundary conditions
    \begin{onlyenv}<4>
      \tikzmark{bc3-cfg}
      \begin{cfgcode}
        [pylithapp.problem]
        bc = [bc_xneg, bc_xpos, bc_yneg, bc_ypos]
        bc.bc_ypos = pylith.bc.DirichletTimeDependent

        [pylithapp.problem.bc.bc_ypos]
        label = boundary_ypos
        label_value = 13
        constrained_dof = [0]
        field = pressure
        db_auxiliary_field = pylith.bc.ZeroDB
        db_auxiliary_field.description = Dirichlet BC for pressure on +y edge

        auxiliary_subfields.initial_amplitude.basis_order = 0
      \end{cfgcode}
    \end{onlyenv}
  \end{minipage}

  \begin{tikzpicture}[overlay,remember picture]
    \draw[physics-arrow,visible on=<2>] ($(pic cs:solution3-cfg)-(0,2em)$) to (pic cs:solution3);
    \draw[physics-arrow,visible on=<3>] ($(pic cs:material3-cfg)-(0,2em)$) to (pic cs:material3);
    \draw[physics-arrow,visible on=<4>] ($(pic cs:bc3-cfg)-(0,2em)$) to (pic cs:bc3);
  \end{tikzpicture}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 3: Input files}
  \summary{}

  \begin{description}
  \item[mesh\_tri.msh] Finite-element mesh generated using Gmsh
  \item[pylithapp.cfg] PyLith parameter file common to all steps
  \item[step03\_gravity\_incompressible.cfg] PyLith parameter file
  \item[mat\_elastic\_incompressible.spatialdb] Spatial database with incompressible elastic properties
  \end{description}

\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}[fragile]
  \frametitle{Step 3: Run the simulation}
  \summary{}

\begin{bashcode}
pylith step03_gravity_incompressible.cfg

# Output
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/apps/PyLithApp.py:77:main
 -- pylithapp(info)
 -- Running on 1 process(es).
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/meshio/MeshIOObj.py:38:read
 -- meshiopetsc(info)
 -- Reading finite-element mesh

# -- many lines omitted --

 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/problems/TimeDependent.py:132:run
 -- timedependent(info)
 -- Solving problem.
0 TS dt 0.01 time 0.
    0 SNES Function norm 1.002609960440e+00
      Linear solve converged due to CONVERGED_ATOL iterations 1
    1 SNES Function norm 1.673501255841e-13
    Nonlinear solve converged due to CONVERGED_FNORM_ABS iterations 1
1 TS dt 0.01 time 0.01
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/problems/Problem.py:199:finalize
 -- timedependent(info)
 -- Finalizing problem.
\end{bashcode}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 3: Visualize results}
  \summary{{\tt pylith\_viz --filenames=output/step02\_gravity\_incompressible-domain.h5 warp\_grid --exaggeration=5}}

  \includefigure[height=7.0cm]{figs/step03-solution}
    
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 3: Visualize results}
  \summary{{\tt pylith\_viz --filenames=\ldots\ warp\_grid --field=cauchy\_stress --component=xy --exaggeration=5}}

  \includefigure[height=7.0cm]{figs/step03-stress}
    
\end{frame}




% ========================================================== SECTION
\subsection{step4-surfload}

% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 4: Overview}
  \summary{Normal tractions applied to simulate a surface load}

  \includefigure[height=6.5cm]{figs/step04-diagram}
      
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 4: Physics}
  \summary{}

  \begin{minipage}{0.3\textwidth}
    {\scriptsize
      \begin{gather*}
        % Solution
        \vec{s} = \left(\begin{array}{c} \vec{u} \end{array}\right)^T \\
        % Elasticity
        \tensor{\nabla} \cdot \tensor{\sigma}(\vec{u}) = \vec{0} \\
        % Dirichlet
        u_x = 0 \text{ on boundary\_xneg} \\
        u_x = 0 \text{ on boundary\_xpos} \\
        u_y = 0 \text{ on boundary\_yneg} \\
        % Neumann
        \tau_n = \tau_0(\vec{x}) \text{ on boundary\_ypos}
    \end{gather*}}
  \end{minipage}
  \hfill
  \begin{minipage}{0.67\textwidth}
    \includefigure[width=\textwidth]{figs/step04-diagram}
  \end{minipage}
      
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}[t,fragile]
  \frametitle{Step 4a: Physics to simulation parameters}
  \summary{}

  \begin{minipage}[t]{0.3\textwidth}
    {\scriptsize
    \begin{gather*}
        % Solution
        \vec{s} = \left(\begin{array}{c} \vec{u} \end{array}\right)^T \tikzmark{solution4}\\
        % Elasticity
        \tensor{\nabla} \cdot \tensor{\sigma}(\vec{u}) = \vec{0} \tikzmark{material4}\\
        % Dirichlet
        u_x = 0 \text{ on boundary\_xneg} \tikzmark{bc4}\\
        u_x = 0 \text{ on boundary\_xpos} \\
        u_y = 0 \text{ on boundary\_yneg} \\
        % Neumann
        \tau_n = \tau_0(\vec{x}) \text{ on boundary\_ypos}
    \end{gather*}}
  \end{minipage}
  \hfill
  \begin{minipage}[t]{0.67\textwidth}
    % Solution
    \begin{onlyenv}<2>
      \tikzmark{solution4-cfg}
      \begin{cfgcode}
        # Default values
        [pylithapp.problem]
        solution = pylith.problems.SolnDisp
        defaults.quadrature_order = 1
        
        [pylithapp.problem.solution.subfields]
        displacement.basis_order = 1
      \end{cfgcode}
    \end{onlyenv}
    %
    % Governing equations
    \begin{onlyenv}<3>
      \tikzmark{material4-cfg}
      \begin{cfgcode}
        # Same as Steps 1 and 2
      \end{cfgcode}
    \end{onlyenv}
    %
    % Boundary conditions
    \begin{onlyenv}<4>
      \tikzmark{bc4-cfg}
      \begin{cfgcode}
        bc = [bc_xneg, bc_xpos, bc_yneg, bc_ypos]
        bc.bc_ypos = pylith.bc.NeumannTimeDependent

        [pylithapp.problem.bc.bc_ypos]
        label = boundary_ypos
        label_value = 13

        db_auxiliary_field = spatialdata.spatialdb.SimpleDB
        db_auxiliary_field.description = Neumann BC +y edge
        db_auxiliary_field.iohandler.filename = traction_surfload.spatialdb
        db_auxiliary_field.query_type = linear

        auxiliary_subfields.initial_amplitude.basis_order = 1
      \end{cfgcode}
    \end{onlyenv}
  \end{minipage}

  \begin{tikzpicture}[overlay,remember picture]
    \draw[physics-arrow,visible on=<2>] ($(pic cs:solution4-cfg)-(0,2em)$) to (pic cs:solution4);
    \draw[physics-arrow,visible on=<3>] ($(pic cs:material4-cfg)-(0,2em)$) to (pic cs:material4);
    \draw[physics-arrow,visible on=<4>] ($(pic cs:bc4-cfg)-(0,2em)$) to (pic cs:bc4);
  \end{tikzpicture}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 4a: Input files}
  \summary{}

  \begin{description}
  \item[mesh\_tri.msh] Finite-element mesh generated using Gmsh
  \item[pylithapp.cfg] PyLith parameter file common to all steps
  \item[step04a\_surfload.cfg] PyLith parameter file
  \item[mat\_elastic.spatialdb] Spatial database with elastic properties
  \item[traction\_surfload.spatialdb] Spatial database with traction distribution for surface load
  \end{description}

\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}[fragile]
  \frametitle{Step 4a: Run the simulation}
  \summary{}

\begin{bashcode}
pylith step04a_surfload.cfg

# Output
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/apps/PyLithApp.py:77:main
 -- pylithapp(info)
 -- Running on 1 process(es).
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/meshio/MeshIOObj.py:38:read
 -- meshiopetsc(info)
 -- Reading finite-element mesh

# -- many lines omitted --

 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/problems/TimeDependent.py:132:run
 -- timedependent(info)
 -- Solving problem.
0 TS dt 0.01 time 0.
    0 SNES Function norm 1.806849275472e-02
      Linear solve converged due to CONVERGED_ATOL iterations 1
    1 SNES Function norm 3.848811582421e-16
    Nonlinear solve converged due to CONVERGED_FNORM_ABS iterations 1
1 TS dt 0.01 time 0.01
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/problems/Problem.py:199:finalize
 -- timedependent(info)
 -- Finalizing problem.
\end{bashcode}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 4a: Visualize results}
  \summary{{\tt pylith\_viz --filenames=output/step04a\_surfload-domain.h5 warp\_grid --exaggeration=500}}

  \includefigure[height=7.0cm]{figs/step04a-solution}
    
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 4a: Visualize results}
  \summary{{\tt pylith\_viz --filenames=\ldots\ warp\_grid --field=cauchy\_stress --component=xy --exaggeration=500}}

  \includefigure[height=7.0cm]{figs/step04a-stress}
    
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}[t,fragile]
  \frametitle{Step 4b: Physics to simulation parameters}
  \summary{}

  \begin{minipage}[t]{0.3\textwidth}
    {\scriptsize
    \begin{gather*}
        % Solution
        \vec{s} = \left(\begin{array}{c} \vec{u} \end{array}\right)^T \tikzmark{solution4}\\
        % Elasticity
        \tensor{\nabla} \cdot \tensor{\sigma}(\vec{u}) = \vec{0} \tikzmark{material4}\\
        % Dirichlet
        u_x = 0 \text{ on boundary\_xneg} \tikzmark{bc4}\\
        u_x = 0 \text{ on boundary\_xpos} \\
        u_y = 0 \text{ on boundary\_yneg} \\
        % Neumann
        \tau_n = \tau_0(\vec{x}) \text{ on boundary\_ypos}
    \end{gather*}}
  \end{minipage}
  \hfill
  \begin{minipage}[t]{0.67\textwidth}
    % Solution
    \begin{onlyenv}<2>
      \tikzmark{solution4-cfg}
      \begin{cfgcode}
        [pylithapp.mesh_generator]
        refiner = pylith.topology.RefineUniform
      \end{cfgcode}
    \end{onlyenv}
  \end{minipage}

  \begin{tikzpicture}[overlay,remember picture]
    \draw[physics-arrow,visible on=<2>] ($(pic cs:solution4-cfg)-(0,2em)$) to (pic cs:solution4);
  \end{tikzpicture}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}[fragile]
  \frametitle{Step 4b: Run the simulation}
  \summary{}

\begin{bashcode}
pylith step04b_surfload.cfg

# Output
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/apps/PyLithApp.py:77:main
 -- pylithapp(info)
 -- Running on 1 process(es).
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/meshio/MeshIOObj.py:38:read
 -- meshiopetsc(info)
 -- Reading finite-element mesh

# -- many lines omitted --

 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/problems/TimeDependent.py:132:run
 -- timedependent(info)
 -- Solving problem.
0 TS dt 0.01 time 0.
    0 SNES Function norm 1.282230294611e-02
      Linear solve converged due to CONVERGED_ATOL iterations 1
    1 SNES Function norm 8.657509862553e-16
    Nonlinear solve converged due to CONVERGED_FNORM_ABS iterations 1
1 TS dt 0.01 time 0.01
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/problems/Problem.py:199:finalize
 -- timedependent(info)
 -- Finalizing problem.
\end{bashcode}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 4b: Visualize results}
  \summary{{\tt pylith\_viz --filenames=output/step04b\_surfload-domain.h5 warp\_grid --exaggeration=500}}

  \includefigure[height=7.0cm]{figs/step04b-solution}
    
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 4b: Visualize results}
  \summary{{\tt pylith\_viz --filenames=\ldots\ warp\_grid --field=cauchy\_stress --component=xy --exaggeration=500}}

  \includefigure[height=7.0cm]{figs/step04b-stress}
    
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}[t,fragile]
  \frametitle{Step 4c: Physics to simulation parameters}
  \summary{}

  \begin{minipage}[t]{0.3\textwidth}
    {\scriptsize
    \begin{gather*}
        % Solution
        \vec{s} = \left(\begin{array}{c} \vec{u} \end{array}\right)^T \tikzmark{solution4}\\
        % Elasticity
        \tensor{\nabla} \cdot \tensor{\sigma}(\vec{u}) = \vec{0} \tikzmark{material4}\\
        % Dirichlet
        u_x = 0 \text{ on boundary\_xneg} \tikzmark{bc4}\\
        u_x = 0 \text{ on boundary\_xpos} \\
        u_y = 0 \text{ on boundary\_yneg} \\
        % Neumann
        \tau_n = \tau_0(\vec{x}) \text{ on boundary\_ypos}
    \end{gather*}}
  \end{minipage}
  \hfill
  \begin{minipage}[t]{0.67\textwidth}
    % Solution
    \begin{onlyenv}<2>
      \tikzmark{solution4-cfg}
      \begin{cfgcode}
        # Default values
        [pylithapp.problem]
        solution = pylith.problems.SolnDisp
        defaults.quadrature_order = 2
        
        [pylithapp.problem.solution.subfields]
        displacement.basis_order = 2
      \end{cfgcode}
    \end{onlyenv}
  \end{minipage}

  \begin{tikzpicture}[overlay,remember picture]
    \draw[physics-arrow,visible on=<2>] ($(pic cs:solution4-cfg)-(0,2em)$) to (pic cs:solution4);
  \end{tikzpicture}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}[fragile]
  \frametitle{Step 4c: Run the simulation}
  \summary{}

\begin{bashcode}
pylith step04c_surfload.cfg

# Output
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/apps/PyLithApp.py:77:main
 -- pylithapp(info)
 -- Running on 1 process(es).
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/meshio/MeshIOObj.py:38:read
 -- meshiopetsc(info)
 -- Reading finite-element mesh

# -- many lines omitted --

 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/problems/TimeDependent.py:132:run
 -- timedependent(info)
 -- Solving problem.
0 TS dt 0.01 time 0.
    0 SNES Function norm 1.351953324913e-02
      Linear solve converged due to CONVERGED_ATOL iterations 1
    1 SNES Function norm 1.106199721426e-15
    Nonlinear solve converged due to CONVERGED_FNORM_ABS iterations 1
1 TS dt 0.01 time 0.01
 >> /software/unix/py3.12-venv/pylith-debug/lib/python3.12/site-packages/pylith/problems/Problem.py:199:finalize
 -- timedependent(info)
 -- Finalizing problem.
\end{bashcode}
  
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 4c: Visualize results}
  \summary{{\tt pylith\_viz --filenames=output/step04c\_surfload-domain.h5 warp\_grid --exaggeration=500}}

  \includefigure[height=7.0cm]{figs/step04c-solution}
    
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 4c: Visualize results}
  \summary{{\tt pylith\_viz --filenames=\ldots\ warp\_grid --field=cauchy\_stress --component=xy --exaggeration=500}}

  \includefigure[height=7.0cm]{figs/step04c-stress}
    
\end{frame}


% ------------------------------------------------------------ SLIDE
\begin{frame}
  \frametitle{Step 4: Key Points}
  \summary{}

  \begin{enumerate}
  \item The displacement field is very similar for the three different discretizations.\pause
  \item The shear stress component is not well resolved with a basis order of 1 and the coarse mesh.\pause
  \item Refining the mesh by a factor of 2 provides better resolution of the shear stress field.\pause
  \item Using a basis order of 2 with the coarse mesh provides better resolution compared with refining the mesh.\pause
  \item \highlight{When resolving the stress field components is important, you will likely want to use a basis order of 2 for the displacement solution subfield.}
  \end{enumerate}

\end{frame}

% ======================================================================
\end{document}


% End of file
